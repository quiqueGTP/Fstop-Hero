<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fstop Hero ‚Äî N√∫meros f (1/3 EV)</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: #151515;
      --panel-2: #1f1f1f;
      --text: #f5f5f5;
      --muted: #b3b3b3;
      --accent: #ffffff;
      --border: #2a2a2a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text); display: grid; place-items: center; padding: 24px;
    }
    .container { width: 100%; max-width: 720px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.00));
      border: 1px solid var(--border); border-radius: 18px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    header, footer { display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
    .muted { color: var(--muted); }
    .btn { cursor: pointer; padding: 12px 18px; border-radius: 12px; border: 1px solid var(--border); background: var(--accent); color: #111; font-weight: 700; }
    .btn.secondary { background: transparent; color: var(--text); }
    .btn:active { transform: translateY(1px); }
    .center { text-align: center; }
    .title { font-size: clamp(28px, 6vw, 44px); font-weight: 800; }
    .subtitle { font-size: 14px; color: var(--muted); }

    /* Timer bar */
    .bar { height: 8px; width: 100%; background: #202020; border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
    .bar > .fill { height: 100%; width: 100%; background: var(--accent); transition: width 80ms linear; }

    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 560px) { .grid { grid-template-columns: 1fr 1fr; } }

    .option { position: relative; overflow: hidden; padding: 20px; border-radius: 16px; border: 1px solid var(--border); background: var(--panel); text-align: left; cursor: pointer; }
    .option:hover { background: var(--panel-2); }
    .option .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .option .value { font-size: clamp(26px, 5vw, 36px); font-weight: 800; letter-spacing: -0.02em; color: #d6d6d6; }

    .lives { letter-spacing: 0.2em; }

    .hidden { display: none !important; }

    /* Cuenta regresiva */
    .count-number { font-size: clamp(48px, 14vw, 120px); font-weight: 900; letter-spacing: -0.03em; }
      
    /* N√∫meros f en gris claro */
    #question, .option .value { color: #d6d6d6; }

    /* Logo Fstop Hero */
    .logo-wrap { display:flex; justify-content:center; margin: 8px auto 6px; }
    .logo-wrap img { max-width: 560px; width: min(85vw, 560px); height: auto; display:block; margin:0 auto; filter: drop-shadow(0 12px 30px rgba(0,0,0,.45)); image-rendering: -webkit-optimize-contrast; }
    .hero-title { display:none; }
    .logo-pixel { shape-rendering: crispEdges; }
  
    /* Errores en rojo */
    .missed-item { color: #ff5a5a; font-weight: 700; }
  
    /* Pantalla de revisi√≥n */
    #screen-review .review-list { max-height: 50vh; overflow: auto; border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: #121212; }
    #screen-review .row { display:grid; grid-template-columns: 40px 1fr 120px; gap: 10px; align-items:center; padding: 6px 4px; border-bottom: 1px dashed #1f1f1f; }
    #screen-review .row:last-child { border-bottom: none; }
    #screen-review input[type="number"] { width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: #0f0f0f; color: #eaeaea; }
    #screen-review .err { color: #ff6b6b; margin-top: 10px; }
    #screen-review .ok { color: #9be29b; margin-top: 10px; }

    /* N√∫meros f en gris claro */
    #question, .option .value { color: #d6d6d6; }
  
    /* Selector de modo/tiempo (tarjetas) */
    .modes { display:grid; grid-template-columns: 1fr; gap:10px; max-width:720px; margin: 14px auto 18px; }
    @media (min-width: 640px){ .modes { grid-template-columns: repeat(4, 1fr); } }
    .modes input[type="radio"]{ display:none; }
    .modes label { display:flex; flex-direction:column; align-items:flex-start; gap:4px; background:#131313; border:1px solid var(--border); padding:12px 14px; border-radius:14px; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease; }
    .modes label:hover { transform: translateY(-2px); box-shadow: 0 8px 26px rgba(0,0,0,.35); }
    .modes .title { font-weight:800; font-size: 16px; letter-spacing:-.01em; }
    .modes .desc  { font-size:12px; color: var(--muted); }
    .modes .icon  { font-size:18px; opacity:.9; }
    .modes input:checked + label { border-color:#fff; box-shadow: 0 0 0 2px rgba(255,255,255,.25), 0 12px 32px rgba(0,0,0,.45); }

    /* Hero de inicio */
    .start-hero { text-align:center; margin: 10px 0 6px; }
    .chip { display:inline-flex; align-items:center; gap:8px; background: #101010; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted); }
    .hero-title { font-size: clamp(34px, 7vw, 64px); font-weight:900; letter-spacing:-.02em; margin:10px 0 4px; background: linear-gradient(180deg, #fff, #cfcfcf 70%); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .hero-sub { font-size:14px; color: var(--muted); max-width: 720px; margin: 0 auto; }

    /* CTA */
    .cta-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top: 14px; }

    /* C√≥mo jugar */
    .how { display:grid; grid-template-columns: 1fr; gap:8px; margin-top:18px; color:var(--muted); }
    @media (min-width: 640px){ .how { grid-template-columns: repeat(3,1fr); } }
    .how .step { display:flex; align-items:center; gap:10px; background:#121212; border:1px dashed var(--border); padding:10px 12px; border-radius:12px; }
    .how .step .ico { font-size:18px; }

    /* N√∫meros f en gris claro */
    #question, .option .value { color: #d6d6d6; }
  
/* Final screen redesign */
.score-box{
  display:inline-flex; align-items:center; justify-content:center;
  background:#ffffff; border-radius:16px; padding:14px 22px; 
  font-size:32px; font-weight:800; letter-spacing:.5px; 
  margin:10px 0 18px; box-shadow: inset 0 2px 0 rgba(0,0,0,.08);

  color:#000;
}
.score-box .pts{ margin-left:8px; font-weight:700; opacity:.85; }
.final-row{
  display:flex; justify-content:space-between; align-items:flex-end;
  width:min(92vw, 620px); margin:18px auto 0; padding:0 6px;
}
.final-row img{ height:140px; image-rendering: pixelated; }
@media (max-width: 520px){
  .final-row img{ height:110px; }
}


.icon-btn{ background:transparent; border:none; padding:0; cursor:pointer; }
.icon-btn:focus{ outline: 2px solid var(--border); outline-offset: 2px; border-radius: 10px; }
.score-box{ background:#ffffff; } /* fondo blanco, texto negro */

</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="subtitle">N√∫meros f ‚Äî tercios de paso (progresivo)</div>
      <div style="display:flex; gap:16px; align-items:center;">
        <div class="subtitle">Puntaje: <strong id="score">0</strong></div>
        <div class="subtitle">Vidas: <strong id="lives" class="lives">‚ù§‚ù§‚ù§</strong></div>
      </div>
    </header>

    <div class="card" id="screen-start">
      <div style="padding:28px 14px;">
        <div class="start-hero">
          <div class="chip">üì∑ 37 turnos ¬∑ 1/3 EV</div>
          <div class="logo-wrap">
            <img id="logo-img" src="fstop-hero-logo.png" alt="Fstop Hero" />
          </div>
          <h1 class="hero-title">Fstop Hero</h1>
          <p class="hero-sub">Aprende y domina los n√∫meros f en tercios de paso. Tienes <strong>3 vidas</strong>. Elige un <strong>modo</strong> y presiona <strong>Comenzar</strong>.</p>
        </div>

        <div class="modes" id="mode-select">
          <input type="radio" id="mode-learn"  name="mode" value="learn" checked>
          <label for="mode-learn"><span class="title">Aprender</span><span class="desc">Sin l√≠mite de tiempo</span></label>

          <input type="radio" id="mode-easy"   name="mode" value="easy">
          <label for="mode-easy"><span class="title">Easy</span><span class="desc">6 segundos</span></label>

          <input type="radio" id="mode-med"    name="mode" value="medium">
          <label for="mode-med"><span class="title">Medium</span><span class="desc">4 segundos</span></label>

          <input type="radio" id="mode-hard"   name="mode" value="hard">
          <label for="mode-hard"><span class="title">Hard</span><span class="desc">2 segundos</span></label>
        </div>

        <div class="cta-row"><button class="btn" id="btn-start">Comenzar</button></div></div>
      </div>
    </div>

    <div class="card hidden" id="screen-count">
      <div class="center" style="padding:38px 8px;">
        <div class="subtitle" style="margin-bottom:6px;">La ronda inicia en‚Ä¶</div>
        <div id="count-number" class="count-number">5</div>
        <p class="subtitle" style="margin-top:10px;">Prep√°rate para elegir el siguiente n√∫mero f en tercios de paso.</p>
      </div>
    </div>

    <div class="card hidden" id="screen-game">
      <div style="margin-bottom:12px;">
        <div class="bar"><div class="fill" id="bar-fill" style="width:100%"></div></div>
        <div class="subtitle" style="display:flex; justify-content:space-between; margin-top:8px;">
          <span>Tiempo restante: <span id="time" aria-live="polite" role="timer">4.00</span> s</span>
          <span>Turno <span id="turn">1</span> de <span id="total">37</span></span>
        </div>
      </div>

      <div class="center" style="margin: 18px 0 24px;">
        <div class="subtitle" id="prompt">Siguiente en la serie (1/3 EV)</div>
        <div id="question" class="title" style="margin-top:6px;">f/1 ‚Üí ?</div>
      </div>

      <div class="grid" id="options">
        <!-- Opciones A/B dinamicas -->
      </div>

      <p class="subtitle center" style="margin-top:16px;">Puntaje por rapidez: &lt;1s = +10 ¬∑ 1‚Äì2s = +5 ¬∑ 2‚Äì4s = +3</p>
    </div>

    

<div class="card hidden" id="screen-final">
  <div class="center" style="padding:38px 8px;">
    <div class="logo-wrap" style="margin-bottom:10px;">
      <img src="fstop-hero-logo.png" alt="Fstop Hero" />
    </div>
    <div class="title">¬°Juego terminado!</div>
    <div class="score-box"><span id="final-score">0</span> <span class="pts">pts</span></div>
    <div id="missed" class="subtitle" style="margin:0 0 20px;"></div>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button class="btn" id="btn-replay">Jugar otra vez</button>
      <button class="btn secondary" id="btn-home">Volver al inicio</button>
    </div>
    <div class="final-row">
      <img src="Ansel_Adams.png" alt="Ansel Adams" />
      <button id="btn-share" class="icon-btn" aria-label="Compartir resultado"><img src="share.png" alt="Compartir" /></button>
    </div>
  </div>
</div>

<p class="subtitle" style="margin:8px 0 18px;"></p>
        <div id="missed" class="subtitle" style="margin:0 0 20px;"></div></div>
    </div>

    <div class="card hidden" id="screen-review">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;">
        <div class="title" style="font-size:24px;">Revisar serie (37)</div>
        <div class="subtitle">Edita si es necesario. Deben ser <strong>37</strong> valores ascendentes.</div>
      </div>
      <div class="review-list" id="review-list"></div>
      <div id="review-msg" class="subtitle" style="margin-top:10px;"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap;">
        <button class="btn secondary" id="btn-reset-review">Restaurar est√°ndar</button>
        <button class="btn secondary" id="btn-cancel-review">Cancelar</button>
        <button class="btn" id="btn-save-review">Guardar y volver</button>
      </div>
    </div>

    <footer class="subtitle" style="margin-top: 10px;">
      
    </footer>
  </div>

  <script>
// ==============================
//  Juego N√∫meros F ‚Äî modos de tiempo
// ==============================

// --- Serie (37 valores) ---
let STOPS = [
  1, 1.1, 1.2, 1.4, 1.6, 1.8,
  2, 2.2, 2.5, 2.8, 3.2, 3.5,
  4, 4.5, 5, 5.6, 6.3, 7.1,
  8, 9, 10, 11, 13, 14,
  16, 18, 20, 22, 25, 29,
  32, 36, 40, 45, 51, 57, 64
];
const DEFAULT_STOPS = [...STOPS];
const TOTAL_TURNS = 37; // recorre toda la serie una sola vez

// --- M√∫sica de fondo (misma carpeta) ---
const bgAudio = new Audio('background.mp3');
bgAudio.loop = true;
bgAudio.preload = 'auto';
bgAudio.volume = 0.25;

// --- Modo de juego y tiempos ---
let ROUND_MS = 4000;            // se ajusta seg√∫n modo seleccionado
let gameMode = 'learn';
const MODE_CONFIG = {
  learn:  { label:'Aprender', ms: Infinity },
  easy:   { label:'Easy',     ms: 6000 },
  medium: { label:'Medium',   ms: 4000 },
  hard:   { label:'Hard',     ms: 2000 },
};
function readSelectedMode(){
  const el = document.querySelector('input[name="mode"]:checked');
  return el ? el.value : 'medium';
}
function applyMode(mode){
  gameMode = mode;
  const cfg = MODE_CONFIG[mode] || MODE_CONFIG.medium;
  // Guardamos un valor por si se necesita calcular, pero en "learn" no disparamos el timer
  ROUND_MS = Number.isFinite(cfg.ms) ? cfg.ms : 4000;
}

// --- Estado ---
let status = 'start'; // start | count | playing | final | review
let turn = 0;         // 1..TOTAL_TURNS
let lives = 3;
let score = 0;
let missed = [];      // f/ correctos fallados (√∫nicos)
let currentCorrect = null; // f/ correcto actual

let startTs = 0;      // inicio de ronda (ms)
let timer = null;
let countdownTimer = null;

// --- Elementos ---
const elScore = document.getElementById('score');
const elLives = document.getElementById('lives');
const elBarFill = document.getElementById('bar-fill');
const elTime = document.getElementById('time');
const elTurn = document.getElementById('turn');
const elTotal = document.getElementById('total');
const elQuestion = document.getElementById('question');
const elPrompt = document.getElementById('prompt');
const elOptions = document.getElementById('options');
const elFinalScore = document.getElementById('final-score');
const elMissed = document.getElementById('missed');

const screenStart = document.getElementById('screen-start');
const screenCount = document.getElementById('screen-count');
const screenGame = document.getElementById('screen-game');
const screenFinal = document.getElementById('screen-final');
const screenReview = document.getElementById('screen-review');

const countNumber = document.getElementById('count-number');
const elTimeBar = document.getElementById('time-bar');
const elTimeWrap = document.getElementById('time-wrap');

const reviewList = document.getElementById('review-list');
const reviewMsg = document.getElementById('review-msg');

// --- Audio FX ---
let audioCtx = null;
function initAudio(){
  if (!audioCtx) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioCtx = new AC();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
}
function tone(freq, duration=0.1, type='sine', volume=0.2){
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq; gain.gain.value = volume;
  osc.connect(gain).connect(audioCtx.destination);
  const now = audioCtx.currentTime; osc.start(now);
  gain.gain.setValueAtTime(volume, now + Math.max(0, duration - 0.04));
  gain.gain.linearRampToValueAtTime(0.0001, now + duration);
  osc.stop(now + duration + 0.01);
}
function playSuccess(){ tone(880, 0.09, 'sine', 0.22); setTimeout(()=>tone(1200, 0.08, 'triangle', 0.20), 110); }
function playError(){ tone(220, 0.14, 'sawtooth', 0.22); setTimeout(()=>tone(160, 0.18, 'square', 0.18), 120); }
function playTick(step){ const base = 750 + (step % 3) * 80; tone(base, 0.05, 'square', 0.18); }

// --- Utilidades ---
function toggle(el, hidden){ if (el) el.classList.toggle('hidden', hidden); }
function setScreen(name){
  toggle(screenStart, name !== 'start');
  toggle(screenCount, name !== 'count');
  toggle(screenGame,  name !== 'game');
  toggle(screenFinal, name !== 'final');
  toggle(screenReview,name !== 'review');
  status = name === 'game' ? 'playing' : name;
}
function hearts(n){ return '‚ù§'.repeat(Math.max(0, n)) + '‚ô°'.repeat(Math.max(0, 3 - n)); }
function formatF(n){ const r = Math.round(n*10)/10; return `f/${Number.isInteger(r) ? r.toFixed(0) : r}`; }
function formatWrong(n){ const r = Math.round(n*10)/10; return `f/${Number.isInteger(r) ? r.toFixed(0) : r}`; }
function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
function shuffle(arr){ return Math.random()>0.5 ? [arr[1], arr[0]] : arr; }
function addMissed(n){ if (n==null) return; const r = Math.round(n*10)/10; if (!missed.some(m=>Math.round(m*10)/10===r)) missed.push(r); }

// Distractores cercanos (m√°s dif√≠ciles)
function generateIncorrect(correct){
  const set = new Set(STOPS); set.add(correct);
  const candidates = [];
  const pushIfValid = (x) => {
    let v = x;
    v = (correct >= 10) ? Math.round(v) : Math.round(v*10)/10;
    if (v > 0.7 && v < 100 && !set.has(v)) candidates.push(v);
  };
  if (correct >= 10){
    pushIfValid(correct + 1); pushIfValid(correct - 1);
    pushIfValid(correct + 2); pushIfValid(correct - 2);
  } else if (correct >= 2){
    pushIfValid(correct + 0.1); pushIfValid(correct - 0.1);
    pushIfValid(correct + 0.2); pushIfValid(correct - 0.2);
  } else {
    pushIfValid(correct + 0.1); pushIfValid(correct - 0.1);
    pushIfValid(correct + 0.2); pushIfValid(correct - 0.2);
    pushIfValid(correct + 0.05); pushIfValid(correct - 0.05);
  }
  for (let k=0; candidates.length===0 && k<40; k++){
    const deltas=[0.03,0.05,0.07,0.09]; const sign=Math.random()<0.5?-1:1;
    pushIfValid(correct*(1 + deltas[Math.floor(Math.random()*deltas.length)]*sign));
  }
  if (candidates.length) return candidates[Math.floor(Math.random()*candidates.length)];
  let fb = (correct >= 10) ? Math.round(correct)+1 : Math.round(correct*10)/10 + 0.1;
  fb = (correct >= 10) ? fb : Math.round(fb*10)/10;
  while (set.has(fb)) fb = (correct >= 10) ? fb+1 : Math.round((fb+0.1)*10)/10;
  return fb;
}

// HUD / Tiempo
function updateHud(){ if (elScore) elScore.textContent = String(score); if (elLives) elLives.textContent = hearts(lives); if (elTurn) elTurn.textContent = String(turn); if (elTotal) elTotal.textContent = String(TOTAL_TURNS); }
function setTimeLeft(ms){ if (elTime) elTime.textContent = (ms/1000).toFixed(2); if (elBarFill){ const pct=Math.max(0, Math.min(100, (ms/ROUND_MS)*100)); elBarFill.style.width = pct + '%'; } }
function startTimer(){
  startTs = performance.now(); setTimeLeft(ROUND_MS); stopTimer();
  timer = setInterval(()=>{
    const elapsed = performance.now() - startTs;
    const left = Math.max(0, ROUND_MS - elapsed);
    setTimeLeft(left);
    if (left <= 0) handleTimeout();
  }, 30);
}
function stopTimer(){ if (timer){ clearInterval(timer); timer = null; } }
function awardScore(elapsedMs){ const s=elapsedMs/1000; score += s<1?10: s<2?5:3; if (elScore) elScore.textContent=String(score); }
function setTimeUI(){
  if (!elTimeBar || !elTimeWrap) return;
  if (gameMode === 'learn'){
    elTimeBar.classList.add('hidden');
    elTimeWrap.classList.add('hidden');
  } else {
    elTimeBar.classList.remove('hidden');
    elTimeWrap.classList.remove('hidden');
    setTimeLeft(ROUND_MS);
  }
}

// Secuencia progresiva (sin repetici√≥n)
function buildPairForTurn(turnNumber){
  if (turnNumber === 1){
    const correct = STOPS[0];
    const wrongVal = generateIncorrect(correct);
    const pair = shuffle([
      { key:'A', value: correct, correct:true,  display: formatF(correct) },
      { key:'B', value: wrongVal,  correct:false, display: formatWrong(wrongVal) },
    ]);
    return { showCurrent:false, currentF:null, correct, pair };
  } else {
    const idx = (turnNumber - 2); // 0..35
    const currentF = STOPS[idx];
    const targetF  = STOPS[idx+1];
    const wrongVal = generateIncorrect(targetF);
    const pair = shuffle([
      { key:'A', value: targetF, correct:true,  display: formatF(targetF) },
      { key:'B', value: wrongVal,  correct:false, display: formatWrong(wrongVal) },
    ]);
    return { showCurrent:true, currentF, correct: targetF, pair };
  }
}

function startRound(){
  const data = buildPairForTurn(turn);
  currentCorrect = data.correct;
  if (elPrompt) elPrompt.textContent = data.showCurrent ? 'Siguiente en la serie (1/3 EV)' : 'Elige el primer n√∫mero de la serie';
  if (elQuestion) elQuestion.textContent = data.showCurrent ? `${formatF(data.currentF)} ‚Üí ?` : `f/Inicio ‚Üí ?`;
  if (elOptions) elOptions.innerHTML = '';
  data.pair.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option';
    btn.setAttribute('aria-label', `Opci√≥n ${opt.key}: ${opt.display}`);
    btn.innerHTML = `<div class="label">Opci√≥n ${opt.key}</div><div class="value">${opt.display}</div>`;
    btn.addEventListener('click', () => handleAnswer(opt));
    elOptions.appendChild(btn);
  });
  setTimeUI();
  if (gameMode !== 'learn') startTimer();
}

function nextTurn(){ stopTimer(); if (lives<=0 || turn>=TOTAL_TURNS) return endGame(); turn++; updateHud(); startRound(); }
function handleAnswer(opt){ if (status!=='playing') return; stopTimer(); const elapsed=performance.now()-startTs; if (opt.correct){ awardScore(elapsed); playSuccess(); } else { addMissed(currentCorrect); lives--; if (elLives) elLives.textContent=hearts(lives); playError(); } if (lives<=0 || turn>=TOTAL_TURNS) endGame(); else nextTurn(); }
function handleTimeout(){ if (status!=='playing') return; stopTimer(); addMissed(currentCorrect); lives--; if (elLives) elLives.textContent=hearts(lives); playError(); if (lives<=0 || turn>=TOTAL_TURNS) endGame(); else nextTurn(); }
function endGame(){ stopTimer(); setScreen('final'); if (elFinalScore) elFinalScore.textContent=String(score); if (elMissed){ elMissed.innerHTML = !missed.length ? '¬°Perfecto! No fallaste ninguna.' : 'Fallaste: ' + missed.map(n=>`<span class="missed-item">${formatF(n)}</span>`).join(' ¬∑ '); }}

// Revisi√≥n de serie (37)
function openReview(){ populateReview(); showReviewMsg('', true); setScreen('review'); }
function populateReview(){ if (!reviewList) return; reviewList.innerHTML=''; STOPS.forEach((v,i)=>{ const row=document.createElement('div'); row.className='row'; row.innerHTML = `<div class="muted">${(i+1).toString().padStart(2,'0')}</div><div class="muted">${i===0?'Primer n√∫mero':'Siguiente'}</div><input type="number" step="0.1" min="0.7" max="100" value="${(Math.round(v*10)/10).toFixed(1)}" data-idx="${i}">`; reviewList.appendChild(row); }); }
function showReviewMsg(msg, ok){ if (!reviewMsg) return; reviewMsg.textContent=msg; reviewMsg.className = ok? 'ok' : 'err'; reviewMsg.classList.add('subtitle'); }
function saveReviewChanges(){ if (!reviewList) return; const inputs=reviewList.querySelectorAll('input'); if (inputs.length!==37){ showReviewMsg('Deben ser 37 valores.', false); return; } const vals=Array.from(inputs).map(inp=>parseFloat(inp.value)); if (vals.some(v=>Number.isNaN(v)||v<=0)){ showReviewMsg('Valores inv√°lidos.', false); return; } for (let i=1;i<vals.length;i++){ if (!(vals[i] > vals[i-1])){ showReviewMsg(`La lista debe ser estrictamente ascendente (error en posici√≥n ${i+1}).`, false); return; } } STOPS = vals.map(v=>Math.round(v*10)/10); showReviewMsg('Guardado. Volviendo al inicio‚Ä¶', true); setTimeout(()=> setScreen('start'), 500); }

// Flujo principal
function reset(){ stopTimer(); if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } status='start'; turn=0; lives=3; score=0; missed=[]; currentCorrect=null; setScreen('start'); updateHud(); setTimeLeft(4000); if (elQuestion) elQuestion.textContent='f/1 ‚Üí ?'; if (elOptions) elOptions.innerHTML=''; if (elMissed) elMissed.textContent=''; }
function startGame(){ applyMode(readSelectedMode()); score=0; lives=3; turn=1; setScreen('game'); updateHud(); startRound(); }
function startCountdown(){ initAudio(); bgAudio.play().catch(()=>{}); let n=5; if (countNumber) countNumber.textContent=String(n); setScreen('count'); if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } countdownTimer=setInterval(()=>{ n-=1; if (n>0){ if (countNumber) countNumber.textContent=String(n); playTick(n); } else { clearInterval(countdownTimer); countdownTimer=null; playTick(0); startGame(); } },1000); }

// Eventos (con comprobaci√≥n de existencia para evitar errores si falta alg√∫n bot√≥n)
const btnStart = document.getElementById('btn-start'); if (btnStart) btnStart.addEventListener('click', startCountdown);
const btnReplay = document.getElementById('btn-replay'); if (btnReplay) btnReplay.addEventListener('click', startCountdown);
const btnHome = document.getElementById('btn-home'); if (btnHome) btnHome.addEventListener('click', reset);
const btnView = document.getElementById('btn-view'); if (btnView) btnView.addEventListener('click', openReview);
const btnViewEnd = document.getElementById('btn-view-end'); if (btnViewEnd) btnViewEnd.addEventListener('click', openReview);
const btnCancelReview = document.getElementById('btn-cancel-review'); if (btnCancelReview) btnCancelReview.addEventListener('click', ()=> setScreen('start'));
const btnSaveReview = document.getElementById('btn-save-review'); if (btnSaveReview) btnSaveReview.addEventListener('click', saveReviewChanges);
const btnResetReview = document.getElementById('btn-reset-review'); if (btnResetReview) btnResetReview.addEventListener('click', ()=>{ STOPS=[...DEFAULT_STOPS]; populateReview(); showReviewMsg('Serie est√°ndar restaurada.', true); });

window.addEventListener('keydown', (e)=>{
  const k = e.key.toLowerCase();
  if (status==='start' && (k==='enter' || k===' ')) startCountdown();
  else if (status==='playing' && (k==='a'||k==='b')){ const children=[...(elOptions?elOptions.children:[])]; const idx=k==='a'?0:1; if (children[idx]) children[idx].click(); }
  else if (status==='final' && (k==='enter'||k==='r')) startCountdown();
});

// ---- Logo: carga con nombres alternativos y fallback a t√≠tulo ----
(function(){
  const img = document.getElementById('logo-img');
  const titleEl = document.querySelector('.hero-title');
  if (!img) return;
  const candidates = [
    'fstop-hero-logo.png', 'Fstop Hero Logo.png', 'Fstop-Hero-Logo.png',
    'fstop_hero_logo.png', 'fstop-hero-logo.webp', 'fstop-hero-logo.jpg',
    'fstop-hero-logo-snes.png', 'fstop-hero-logo-snes.svg', 'logo.png', 'logo.svg'
  ];
  let i = 0;
  function tryNext(){
    if (i >= candidates.length){
      // No se encontr√≥ ninguna: quitamos img y mostramos el t√≠tulo
      if (img && img.parentNode) img.parentNode.removeChild(img);
      if (titleEl) titleEl.style.display = 'block';
      return;
    }
    const src = candidates[i++];
    img.src = src;
  }
  img.addEventListener('error', tryNext);
  // Si carga bien, mostramos imagen y ocultamos t√≠tulo
  img.addEventListener('load', () => { if (titleEl) titleEl.style.display = 'none'; });
  // Comienza intentos
  tryNext();
})();

// Inicio
reset();


// ---- Compartir resultado (Instagram-ready) ----
(function(){
  const btnShare = document.getElementById('btn-share');
  if (!btnShare) return;

  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = ()=> resolve(img);
      img.onerror = reject;
      img.src = src;
    });
  }

  async function composeImage(){
    const W = 1080, H = 1920; // Tama√±o feed vertical de Instagram
    const pad = 48;
    const cnv = document.createElement('canvas');
    cnv.width = W; cnv.height = H;
    const ctx = cnv.getContext('2d');

    // Fondo
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#0d0d0f');
    g.addColorStop(1, '#1a1a1a');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // Panel central
    const panelH = 1380;
    const panelY = (H - panelH)/2 - 30;
    ctx.fillStyle = '#121212';
    ctx.strokeStyle = '#2a2a2a';
    ctx.lineWidth = 8;
    const r = 42;
    // rounded rect
    ctx.beginPath();
    ctx.moveTo(pad+r, panelY);
    ctx.lineTo(W-pad-r, panelY);
    ctx.quadraticCurveTo(W-pad, panelY, W-pad, panelY+r);
    ctx.lineTo(W-pad, panelY+panelH-r);
    ctx.quadraticCurveTo(W-pad, panelY+panelH, W-pad-r, panelY+panelH);
    ctx.lineTo(pad+r, panelY+panelH);
    ctx.quadraticCurveTo(pad, panelY+panelH, pad, panelY+panelH-r);
    ctx.lineTo(pad, panelY+r);
    ctx.quadraticCurveTo(pad, panelY, pad+r, panelY);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    // Logo
    try {
      const logo = await loadImage('fstop-hero-logo.png');
      const logoMaxW = W - pad*2 - 80;
      const scale = Math.min(1, logoMaxW / logo.width);
      const lw = logo.width*scale, lh = logo.height*scale;
      ctx.drawImage(logo, (W-lw)/2, panelY + 40, lw, lh);
    } catch(e){ /* contin√∫a sin logo */ }

    // T√≠tulo
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 92px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.textAlign = 'center';
    ctx.fillText('¬°Juego terminado!', W/2, panelY + 420);

    // Puntaje en chip blanco
    const scoreEl = document.getElementById('final-score');
    const score = scoreEl ? scoreEl.textContent.trim() : '0';
    const chipText = score + ' pts';
    ctx.font = 'bold 120px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    const tw = ctx.measureText(chipText).width;
    const chipW = tw + 120, chipH = 180, chipY = panelY + 520;
    // chip
    ctx.fillStyle = '#ffffff';
    // chip rounded
    const cx = (W - chipW)/2;
    const cy = chipY;
    const rr = 36;
    ctx.beginPath();
    ctx.moveTo(cx+rr, cy);
    ctx.lineTo(cx+chipW-rr, cy);
    ctx.quadraticCurveTo(cx+chipW, cy, cx+chipW, cy+rr);
    ctx.lineTo(cx+chipW, cy+chipH-rr);
    ctx.quadraticCurveTo(cx+chipW, cy+chipH, cx+chipW-rr, cy+chipH);
    ctx.lineTo(cx+rr, cy+chipH);
    ctx.quadraticCurveTo(cx, cy+chipH, cx, cy+chipH-rr);
    ctx.lineTo(cx, cy+rr);
    ctx.quadraticCurveTo(cx, cy, cx+rr, cy);
    ctx.closePath();
    ctx.fill();
    // texto negro
    ctx.fillStyle = '#000000';
    ctx.textBaseline = 'middle';
    ctx.fillText(chipText, W/2, cy + chipH/2 + 4);

    // Fallaste...
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';
    ctx.font = '600 44px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    const missedText = (typeof missed !== 'undefined' && missed.length)
      ? 'Fallaste: ' + missed.map(n=>formatF(n)).join(' ¬∑ ')
      : '¬°Perfecto! No fallaste ning√∫n valor ‚ú®';
    ctx.fillStyle = '#dddddd';
    wrapFillText(ctx, missedText, W/2, cy + chipH + 180, W - pad*2 - 80, 54);

    // Marca inferior
    ctx.font = '500 32px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = '#999';
    ctx.fillText('Fstop Hero ‚Äî N√∫meros f (1/3 EV)', W/2, H - 40);

    return new Promise((resolve)=> cnv.toBlob(b=> resolve({blob:b, canvas:cnv}), 'image/png'));
  }

  function wrapFillText(ctx, text, xCenter, yStart, maxWidth, lineHeight){
    const words = text.split(/\s+/);
    let line = '';
    const lines = [];
    for (let w of words){
      const test = line ? line + ' ' + w : w;
      if (ctx.measureText(test).width > maxWidth){
        if (line) lines.push(line);
        line = w;
      } else {
        line = test;
      }
    }
    if (line) lines.push(line);
    let y = yStart;
    for (const ln of lines){
      ctx.fillText(ln, xCenter, y);
      y += lineHeight;
    }
  }

  async function shareResult(){
    try {
      const {blob} = await composeImage();
      const file = new File([blob], 'fstop-hero-resultado.png', { type: 'image/png' });

      if (navigator.canShare && navigator.canShare({ files: [file] })){
        await navigator.share({
          files: [file],
          title: 'Mi resultado en Fstop Hero',
          text: 'Practiqu√© n√∫meros f ‚Äî ¬°pru√©balo t√∫ tambi√©n!'
        });
      } else {
        // Fallback: descarga directa
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'fstop-hero-resultado.png';
        document.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
        alert('Imagen guardada. S√∫bela a Instagram como publicaci√≥n o historia üì∑');
      }
    } catch(err){
      console.error('Error al generar imagen de resultado', err);
      alert('No se pudo generar la imagen. Intenta de nuevo.');
    }
  }

  btnShare.addEventListener('click', shareResult);
})();

</script>
</body>
</html>
