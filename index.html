<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Juego de Números F – Tercios de paso</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --panel: #151515;
      --panel-2: #1f1f1f;
      --text: #f5f5f5;
      --muted: #b3b3b3;
      --accent: #ffffff;
      --border: #2a2a2a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg); color: var(--text); display: grid; place-items: center; padding: 24px;
    }
    .container { width: 100%; max-width: 720px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.00));
      border: 1px solid var(--border); border-radius: 18px; padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    header, footer { display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 12px; }
    .muted { color: var(--muted); }
    .btn { cursor: pointer; padding: 12px 18px; border-radius: 12px; border: 1px solid var(--border); background: var(--accent); color: #111; font-weight: 700; }
    .btn.secondary { background: transparent; color: var(--text); }
    .btn:active { transform: translateY(1px); }
    .center { text-align: center; }
    .title { font-size: clamp(28px, 6vw, 44px); font-weight: 800; }
    .subtitle { font-size: 14px; color: var(--muted); }

    /* Timer bar */
    .bar { height: 8px; width: 100%; background: #202020; border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
    .bar > .fill { height: 100%; width: 100%; background: var(--accent); transition: width 80ms linear; }

    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 560px) { .grid { grid-template-columns: 1fr 1fr; } }

    .option { position: relative; overflow: hidden; padding: 20px; border-radius: 16px; border: 1px solid var(--border); background: var(--panel); text-align: left; cursor: pointer; }
    .option:hover { background: var(--panel-2); }
    .option .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .option .value { font-size: clamp(26px, 5vw, 36px); font-weight: 800; letter-spacing: -0.02em; color: #d6d6d6; }

    .lives { letter-spacing: 0.2em; }

    .hidden { display: none !important; }

    /* Cuenta regresiva */
    .count-number { font-size: clamp(48px, 14vw, 120px); font-weight: 900; letter-spacing: -0.03em; }
      
    /* Números f en gris claro */
    #question, .option .value { color: #d6d6d6; }
  
    /* Errores en rojo */
    .missed-item { color: #ff5a5a; font-weight: 700; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="subtitle">Números f — tercios de paso (progresivo)</div>
      <div style="display:flex; gap:16px; align-items:center;">
        <div class="subtitle">Puntaje: <strong id="score">0</strong></div>
        <div class="subtitle">Vidas: <strong id="lives" class="lives">❤❤❤</strong></div>
      </div>
    </header>

    <div class="card" id="screen-start">
      <div class="center" style="padding:38px 8px;">
        <div class="title">Aprende los números f (1/3 EV)</div>
        <p class="subtitle" style="max-width:560px; margin: 10px auto 24px;">
          Tienes 37 turnos. Elige el <strong>siguiente número f</strong> en <strong>tercios de paso</strong> (1/3 EV). Solo una opción es real; la otra es un número incorrecto. 3 vidas y <strong>4 segundos</strong> por turno.
        </p>
        <button class="btn" id="btn-start">Comenzar</button>
      </div>
    </div>

    <div class="card hidden" id="screen-count">
      <div class="center" style="padding:38px 8px;">
        <div class="subtitle" style="margin-bottom:6px;">La ronda inicia en…</div>
        <div id="count-number" class="count-number">5</div>
        <p class="subtitle" style="margin-top:10px;">Prepárate para elegir el siguiente número f en tercios de paso.</p>
      </div>
    </div>

    <div class="card hidden" id="screen-game">
      <div style="margin-bottom:12px;">
        <div class="bar"><div class="fill" id="bar-fill" style="width:100%"></div></div>
        <div class="subtitle" style="display:flex; justify-content:space-between; margin-top:8px;">
          <span>Tiempo restante: <span id="time" aria-live="polite" role="timer">4.00</span> s</span>
          <span>Turno <span id="turn">1</span> de <span id="total">37</span></span>
        </div>
      </div>

      <div class="center" style="margin: 18px 0 24px;">
        <div class="subtitle" id="prompt">Siguiente en la serie (1/3 EV)</div>
        <div id="question" class="title" style="margin-top:6px;">f/1 → ?</div>
      </div>

      <div class="grid" id="options">
        <!-- Opciones A/B dinamicas -->
      </div>

      <p class="subtitle center" style="margin-top:16px;">Puntaje por rapidez: &lt;1s = +10 · 1–2s = +5 · 2–4s = +3</p>
    </div>

    <div class="card hidden" id="screen-final">
      <div class="center" style="padding:38px 8px;">
        <div class="title">¡Juego terminado!</div>
        <p class="subtitle" style="margin:8px 0 18px;">Puntaje total: <strong id="final-score">0</strong></p>
        <div id="missed" class="subtitle" style="margin:0 0 20px;"></div>
        <div style="display:flex; gap:10px; justify-content:center;">
          <button class="btn" id="btn-replay">Jugar otra vez</button>
          <button class="btn secondary" id="btn-home">Volver al inicio</button>
        </div>
      </div>
    </div>

    <footer class="subtitle" style="margin-top: 10px;">
      Elige el siguiente número f: solo una opción pertenece a la serie estándar en tercios de paso (1/3 EV).
    </footer>
  </div>

  <script>
  // === Configuración ===
  const STOPS = [
    1, 1.1, 1.2, 1.4, 1.6, 1.8,
    2, 2.2, 2.5, 2.8, 3.2, 3.5,
    4, 4.5, 5, 5.6, 6.3, 7.1,
    8, 9, 10, 11, 13, 14,
    16, 18, 20, 22, 25, 29,
    32, 36, 40, 45, 51, 57, 64
  ];
  const TOTAL_TURNS = 37;          // recorre toda la serie una sola vez
  const ROUND_MS = 4000;           // 4 segundos por turno

  // === Estado ===
  let status = 'start';            // start | count | playing | final
  let turn = 0;                    // 1..TOTAL_TURNS
  let lives = 3;
  let score = 0;
  let missed = [];                 // f/ correctos fallados (únicos)
  let currentCorrect = null;       // f/ correcto de la ronda actual

  let startTs = 0;
  let timer = null;
  let countdownTimer = null;

  // === Elementos ===
  const elScore = document.getElementById('score');
  const elLives = document.getElementById('lives');
  const elBarFill = document.getElementById('bar-fill');
  const elTime = document.getElementById('time');
  const elTurn = document.getElementById('turn');
  const elTotal = document.getElementById('total');
  const elQuestion = document.getElementById('question');
  const elPrompt = document.getElementById('prompt');
  const elOptions = document.getElementById('options');
  const elFinalScore = document.getElementById('final-score');
  const elMissed = document.getElementById('missed');

  const screenStart = document.getElementById('screen-start');
  const screenCount = document.getElementById('screen-count');
  const screenGame = document.getElementById('screen-game');
  const screenFinal = document.getElementById('screen-final');
  const countNumber = document.getElementById('count-number');

  // --- Música de fondo (en la misma carpeta): background.mp3 ---
  const bgAudio = new Audio('background.mp3');
  bgAudio.loop = true;            // repetir en bucle
  bgAudio.preload = 'auto';       // intenta precargar
  bgAudio.volume = 0.25;          // volumen inicial (25%)

  // === Sonidos (WebAudio) ===
  let audioCtx = null;
  function initAudio(){
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }
  function tone(freq, duration=0.1, type='sine', volume=0.2){
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq; gain.gain.value = volume;
    osc.connect(gain).connect(audioCtx.destination);
    const now = audioCtx.currentTime; osc.start(now);
    gain.gain.setValueAtTime(volume, now + Math.max(0, duration - 0.04));
    gain.gain.linearRampToValueAtTime(0.0001, now + duration);
    osc.stop(now + duration + 0.01);
  }
  function playSuccess(){ tone(880, 0.09, 'sine', 0.22); setTimeout(()=>tone(1200, 0.08, 'triangle', 0.20), 110); }
  function playError(){ tone(220, 0.14, 'sawtooth', 0.22); setTimeout(()=>tone(160, 0.18, 'square', 0.18), 120); }
  function playTick(step){ const base = 750 + (step % 3) * 80; tone(base, 0.05, 'square', 0.18); }

  // === Utilidades ===
  function setScreen(name){
    screenStart.classList.toggle('hidden', name !== 'start');
    screenCount.classList.toggle('hidden', name !== 'count');
    screenGame.classList.toggle('hidden', name !== 'game');
    screenFinal.classList.toggle('hidden', name !== 'final');
    status = name === 'game' ? 'playing' : name;
  }
  function hearts(n){ return '❤'.repeat(Math.max(0, n)) + '♡'.repeat(Math.max(0, 3 - n)); }
  function formatF(n){ const r = Math.round(n*10)/10; return `f/${Number.isInteger(r) ? r.toFixed(0) : r}`; }
  function formatWrong(n){
    let label; if (n >= 10) label = String(Math.round(n));
    else if (Number.isInteger(n)) label = Math.random()<0.5 ? `${n.toFixed(0)}.` : n.toFixed(0);
    else label = (Math.round(n*10)/10).toString();
    return `f/${label}`;
  }
  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function generateIncorrect(correct){
    const set = new Set(STOPS); set.add(correct);
    for (let i=0;i<120;i++){
      let candidate;
      if (correct >= 10){
        if (Math.random() < 0.7) candidate = Math.round(correct) + randInt(-3,3);
        else candidate = Math.round((Math.round(correct/5)*5) + [0,5,-5][randInt(0,2)]);
        candidate = Math.max(2, Math.min(90, candidate));
      } else {
        if (Math.random() < 0.6) candidate = Math.max(1, Math.round(correct) + randInt(-2,2));
        else {
          const base = Math.max(1, Math.round(correct) + randInt(-1,1));
          const tenths = [0.0, 0.2, 0.3, 0.7, 0.9];
          candidate = Math.round((base + tenths[randInt(0, tenths.length-1)])*10)/10;
        }
      }
      if (candidate <= 0.7 || candidate >= 100) continue;
      if (set.has(candidate)) continue;
      return candidate;
    }
    let fb = Math.max(2, Math.round(correct)+1); while (set.has(fb)) fb++; return fb;
  }
  function shuffle(arr){ return Math.random()>0.5 ? [arr[1], arr[0]] : arr; }
  function updateHud(){ elScore.textContent = String(score); elLives.textContent = hearts(lives); elTurn.textContent = String(turn); elTotal.textContent = String(TOTAL_TURNS); }

  function startTimer(){
    startTs = performance.now(); setTimeLeft(ROUND_MS); stopTimer();
    timer = setInterval(()=>{
      const elapsed = performance.now() - startTs;
      const left = Math.max(0, ROUND_MS - elapsed);
      setTimeLeft(left);
      if (left <= 0) handleTimeout();
    }, 30);
  }
  function stopTimer(){ if (timer){ clearInterval(timer); timer = null; } }
  function setTimeLeft(ms){ elTime.textContent = (ms/1000).toFixed(2); elBarFill.style.width = `${Math.max(0, Math.min(100, (ms/ROUND_MS)*100))}%`; }
  function awardScore(elapsedMs){ const s=elapsedMs/1000; score += s<1?10: s<2?5:3; elScore.textContent = String(score); }

  // === Secuencia progresiva (sin repetición) ===
  function buildPairForTurn(turnNumber){
    if (turnNumber === 1){
      const correct = STOPS[0];
      const pair = shuffle([
        { key:'A', value: correct, correct:true, display: formatF(correct) },
        { key:'B', value: generateIncorrect(correct), correct:false, display: formatWrong(generateIncorrect(correct)) }
      ]);
      return { showCurrent:false, currentF:null, correct, pair };
    } else {
      const idx = (turnNumber - 2);           // 0..35
      const currentF = STOPS[idx];
      const targetF  = STOPS[idx+1];
      const wrongVal = generateIncorrect(targetF);
      const pair = shuffle([
        { key:'A', value: targetF, correct:true,  display: formatF(targetF) },
        { key:'B', value: wrongVal,  correct:false, display: formatWrong(wrongVal) }
      ]);
      return { showCurrent:true, currentF, correct:targetF, pair };
    }
  }

  function addMissed(n){ if (n==null) return; const r = Math.round(n*10)/10; if (!missed.some(m => Math.round(m*10)/10===r)) missed.push(r); }

  function startRound(){
    const data = buildPairForTurn(turn);
    currentCorrect = data.correct;
    if (elPrompt) elPrompt.textContent = data.showCurrent ? 'Siguiente en la serie (1/3 EV)' : 'Elige el primer número de la serie';
    elQuestion.textContent = data.showCurrent ? `${formatF(data.currentF)} → ?` : `f/Inicio → ?`;
    elOptions.innerHTML = '';
    data.pair.forEach(opt=>{
      const btn=document.createElement('button');
      btn.className='option';
      btn.setAttribute('aria-label', `Opción ${opt.key}: ${opt.display}`);
      btn.innerHTML = `<div class="label">Opción ${opt.key}</div><div class="value">${opt.display}</div>`;
      btn.addEventListener('click', ()=> handleAnswer(opt));
      elOptions.appendChild(btn);
    });
    startTimer();
  }

  function nextTurn(){ stopTimer(); if (lives<=0 || turn>=TOTAL_TURNS) return endGame(); turn++; updateHud(); startRound(); }
  function handleAnswer(opt){ if (status!=='playing') return; stopTimer(); const elapsed=performance.now()-startTs; if (opt.correct){ awardScore(elapsed); playSuccess(); } else { addMissed(currentCorrect); lives--; elLives.textContent=hearts(lives); playError(); } if (lives<=0 || turn>=TOTAL_TURNS) endGame(); else nextTurn(); }
  function handleTimeout(){ if (status!=='playing') return; stopTimer(); addMissed(currentCorrect); lives--; elLives.textContent=hearts(lives); playError(); if (lives<=0 || turn>=TOTAL_TURNS) endGame(); else nextTurn(); }
  function endGame(){ stopTimer(); setScreen('final'); elFinalScore.textContent=String(score); elMissed.innerHTML = !missed.length ? '¡Perfecto! No fallaste ninguna.' : 'Fallaste: ' + missed.map(n=>`<span class="missed-item">${formatF(n)}</span>`).join(' · '); }

  function reset(){ stopTimer(); if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } status='start'; turn=0; lives=3; score=0; missed=[]; currentCorrect=null; setScreen('start'); updateHud(); setTimeLeft(ROUND_MS); elQuestion.textContent='f/1 → ?'; elOptions.innerHTML=''; if (elMissed) elMissed.textContent=''; }
  function startGame(){ score=0; lives=3; turn=1; setScreen('game'); updateHud(); startRound(); }
  function startCountdown(){ initAudio();
    // intenta reproducir la música tras el gesto del usuario (clic/Enter)
    bgAudio.play().catch(()=>{}); let n=5; countNumber.textContent=String(n); setScreen('count'); if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } countdownTimer=setInterval(()=>{ n-=1; if (n>0){ countNumber.textContent=String(n); playTick(n); } else { clearInterval(countdownTimer); countdownTimer=null; playTick(0); startGame(); } },1000); }

  // === Eventos ===
  document.getElementById('btn-start').addEventListener('click', startCountdown);
  document.getElementById('btn-replay').addEventListener('click', startCountdown);
  document.getElementById('btn-home').addEventListener('click', reset);
  window.addEventListener('keydown', (e)=>{
    const k=e.key.toLowerCase();
    if (status==='start' && (k==='enter' || k===' ')) startCountdown();
    else if (status==='playing' && (k==='a'||k==='b')){ const children=[...elOptions.children]; const idx=k==='a'?0:1; if (children[idx]) children[idx].click(); }
    else if (status==='final' && (k==='enter'||k==='r')) startCountdown();
  });

  // === Inicio ===
  reset();
</script>
</body>
</html>
